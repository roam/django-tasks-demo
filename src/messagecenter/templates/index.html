<!doctype html>
{% load django_htmx %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Home Control</title>
    <style>
        :root {
            font-family: system-ui;
        }

        body {
            background: #f3f6f9;
        }

        main {
            max-width: 30rem;
            margin: 2rem auto;
        }

        .icon {
            width: 1rem;
            padding-inline: .5rem;
        }

        .result[data-status="SUCCESSFUL"] .icon {
            color: green;
        }

        .result[data-status="FAILED"] .icon {
            color: red;
        }

        .result[data-status="READY"] .icon {
            color: #939699;
        }

        #results {
            background: #fff;
            border: 1px solid #d3d6d9;
            display: grid;
            grid-template-columns: 2rem 4rem 10rem 1fr;
            border-radius: .25rem;
        }

        .result {
            display: grid;
            grid-column: -1 / 1;
            grid-template-columns: subgrid;
            padding-block: .5rem;
        }

        .result:not(:first-child) {
            border-top: 1px solid #d3d6d9;
        }

        form {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #d3d6d9;
            margin-block-end: 2rem;
            padding: 1rem;
            border-radius: .25rem;
            gap: 1rem;
        }

        textarea, input[type="text"] {
            font-family: inherit;
            padding: .5rem;
            appearance: none;
            border: 1px solid #939699;
            width: calc(100% - 1rem);
            border-radius: .25rem;
            resize: none;
        }

        label {
            display: block;
            font-size: 0.875rem;
            padding-block-end: .25em;
            padding-inline-start: .25em;
        }

        form p {
            margin: 0;
        }
    </style>
    {% htmx_script %}
</head>
<body hx-headers='{"x-csrftoken": "{{ csrf_token }}"}'>
<main>
    {% partial form %}
    <div id="results">
        {% for result in results %}
            {% partial result %}
        {% endfor %}
    </div>
    {% partialdef form %}
        <form action="." method="post" hx-post="{% url "index" %}" hx-swap="outerHTML">
            {{ form.as_p }}
            <div class="buttons">
                <button type="submit">Send</button>
            </div>
        </form>
    {% endpartialdef %}
    {% partialdef result %}
        <div class="result" data-status="{{ result.status }}" {% if not result.is_finished %}
             hx-get="{% url "hx-task-result" result_id=result.id status=result.status %}"
             hx-trigger="every 1s" hx-swap="outerHTML"{% endif %}>
            <div class="icon">
                {% if result.status == "SUCCESSFUL" %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"/>
                    </svg>
                {% elif result.status == "FAILED" %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM165.66,154.34a8,8,0,0,1-11.32,11.32L128,139.31l-26.34,26.35a8,8,0,0,1-11.32-11.32L116.69,128,90.34,101.66a8,8,0,0,1,11.32-11.32L128,116.69l26.34-26.35a8,8,0,0,1,11.32,11.32L139.31,128Z"/>
                    </svg>
                {% elif result.status == "READY" %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M32,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H40A8,8,0,0,1,32,64Zm104,56H40a8,8,0,0,0,0,16h96a8,8,0,0,0,0-16Zm0,64H40a8,8,0,0,0,0,16h96a8,8,0,0,0,0-16Zm112-24a8,8,0,0,1-3.76,6.78l-64,40A8,8,0,0,1,168,200V120a8,8,0,0,1,12.24-6.78l64,40A8,8,0,0,1,248,160Zm-23.09,0L184,134.43v51.14Z"/>
                    </svg>
                {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                        <path d="M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"/>
                    </svg>
                {% endif %}
            </div>
            <div class="id">{{ result.id }}</div>
            <div class="timestamp">{{ result.enqueued_at|date:"Y-m-d H:i:s" }}</div>
            <div class="status">{{ result.status.label }}</div>
        </div>
    {% endpartialdef %}
    {% partialdef prepend-result %}
        <div id="results" hx-swap-oob="afterbegin">
            {% partial result %}
        </div>
    {% endpartialdef %}
</main>
</body>
</html>
